<!DOCTYPE html>
<html lang="vi">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width,initial-scale=1">
  <title>Creatine | YOUNGKH WHEY</title>
  <!-- Icons (Font Awesome) -->
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css">
  <link rel="stylesheet" href="phonggym.css">
</head>
<body>
  <!-- HEADER -->
 <header class="site-header">
    <div class="header-inner">

      <!-- ==== LOGO + DANH MỤC ==== -->
      <div class="left-block">
        <div class="logo-catalog">
          <a href="TrangChu.html" class="brand">
            <img src="/IMG/logo1.png" alt="logo" />
          </a>
          <div class="catalog-btn"><i class="fa fa-bars"></i> <span class="cat-label">Danh Mục Sản Phẩm</span></div>
        </div>
      </div>

      <!-- ==== THANH TÌM KIẾM ==== -->
      <div class="center-block">
        <div class="search">
          <input id="searchInput" type="search" placeholder="Tìm kiếm bài viết hoặc thông tin..." autocomplete="off">
          <button id="searchBtn">Tìm Kiếm</button>
        </div>
      </div>

      <!-- ==== TÀI KHOẢN / YÊU THÍCH / GIỎ HÀNG ==== -->
      <div class="right-block">
        <button class="icon-btn"><i class="fa-regular fa-user"></i><span> Tài Khoản</span></button>
        <a href="yeuThich.html" id="wishlistBtn" class="cart icon-btn" title="Sản phẩm yêu thích"><i class="fa-regular fa-heart"></i><span id="wishlistCount">0</span></a>
        <div id="cartBtn" class="cart icon-btn"><i class="fa-solid fa-cart-shopping"></i><span id="cartCount">0</span></div>
      </div>

    </div>
  </header>
  <section class="promo-banner">
    <img src="/IMG/giam gia.png" alt="promo banner" onerror="this.style.display='none'">
  </section>
  <!-- ====== CART PANEL ====== -->
  <aside id="cartPanel" class="cart-panel hidden">
    <div class="cart-head">
      <h3>Giỏ hàng</h3>
      <button id="closeCart" class="icon-btn"><i class="fa-solid fa-xmark"></i></button>
    </div>
    <div id="cartItems" class="cart-items"></div>
    <div class="cart-foot">
      <div>Tổng: <strong id="cartTotal">0₫</strong></div>
      <button id="checkoutBtn" class="btn-primary">Thanh toán</button>
    </div>
  </aside>

  <!-- ====== MAIN ====== -->
  <main class="container">
    <!-- DANH MỤC BÊN TRÁI -->
    <aside class="sidebar">
      <h4>Bộ lọc</h4>

      <div class="filter-block">
        <h5>Trạng thái tồn kho</h5>
        <label><input type="checkbox" id="filter-instock"> Còn Hàng</label><br>
        <label><input type="checkbox" id="filter-outstock"> Hết Hàng</label>
      </div>

      <div class="filter-block">
        <h5>Khoảng giá</h5>
        <div class="price-range">
          <input type="number" id="priceMin" placeholder="Từ" style="width:45%;"> -
          <input type="number" id="priceMax" placeholder="Đến" style="width:45%;">
        </div>
        <small class="muted">Giá cao nhất hiện là <strong id="priceMaxLabel">4.316.000₫</strong></small>
      </div>

      <div class="filter-block">
        <h5>Hãng / Sản phẩm (Creatine)</h5>
        <div class="brand-list">
          <label><input type="checkbox" class="brand-checkbox" value="creatine"> Creatine</label><br>
          <label><input type="checkbox" class="brand-checkbox" value="micronized"> Micronized</label><br>
          <label><input type="checkbox" class="brand-checkbox" value="bandidi"> Bandidi</label><br>
          <label><input type="checkbox" class="brand-checkbox" value="pure creatine"> Pure Creatine</label><br>
          <label><input type="checkbox" class="brand-checkbox" value="rule"> Rule1</label><br>
          <label><input type="checkbox" class="brand-checkbox" value="ostrovit"> Ostrovit</label>
        </div>
      </div>

      <div class="filter-block">
        <button id="applyFilters" class="btn-primary">Áp dụng lọc</button>
        <button id="clearFilters" class="btn-outline">Xóa lọc</button>
      </div>
    </aside>

    <!-- DANH SÁCH SẢN PHẨM -->
    <section class="products">
      <div class="products-head" style="display:flex;justify-content:space-between;align-items:center;gap:12px;flex-wrap:wrap">
        <div style="flex:1;min-width:260px">
          <div class="breadcrumb" style="color:#64748b;font-size:13px;margin-bottom:6px"></div>
          <h2 style="margin:0"></h2>
          <div class="result-count muted" id="resultCount">0 Sản Phẩm</div>
        </div>

        <div style="display:flex;align-items:center;gap:12px">
          <div class="view-controls" title="Chọn kiểu hiển thị">
            <button class="icon-btn"><i class="fa-solid fa-table-cells-large"></i></button>
            <button class="icon-btn"><i class="fa-solid fa-border-all"></i></button>
            <button class="icon-btn"><i class="fa-solid fa-list"></i></button>
          </div>

          <div class="sort-controls">
            <label>Sắp xếp theo:</label>
            <select id="sortSelect">
              <option value="featured">Featured</option>
              <option value="price-asc">Giá: thấp → cao</option>
              <option value="price-desc">Giá: cao → thấp</option>
            </select>
          </div>
        </div>
      </div>
      <div id="debugMsg" style="padding:8px 0;color:#333;font-weight:600"></div>
      <div id="productGrid" class="product-grid"></div>
    </section>
  </main>

  <!-- ====== FOOTER ====== -->
  <footer class="site-footer">
    <div class="footer-top">
      <div class="ft-icons">
        <div class="ft-icon"><i class="fa-solid fa-truck-fast"></i>
          <h5>HỖ TRỢ PHÍ SHIP</h5>
          <p>100% Hỗ Trợ Toàn Quốc</p>
        </div>
        <div class="ft-icon"><i class="fa-solid fa-tag"></i>
          <h5>GIÁ NIÊM YẾT</h5>
          <p>100% Giá Niêm Yết</p>
        </div>
        <div class="ft-icon"><i class="fa-solid fa-headset"></i>
          <h5>TRUNG TÂM CHĂM SÓC</h5>
          <p>Hỗ Trợ và Tư Vấn 24/7</p>
        </div>
        <div class="ft-icon"><i class="fa-solid fa-rotate-left"></i>
          <h5>CHÍNH SÁCH TRẢ HÀNG</h5>
          <p>Đổi/Trả Hàng Miễn Phí</p>
        </div>
      </div>

      <div class="footer-cols">
        <div class="ft-col">
          <h4>GIỚI THIỆU</h4>
          <ul>
            <li>Giới Thiệu Công Ty</li>
            <li>Thông Tin Liên Hệ</li>
            <li>Tin Tuyển Dụng</li>
            <li>Kiểm Tra Đơn hàng</li>
          </ul>
        </div>
        <div class="ft-col">
          <h4>TÍCH ĐIỂM</h4>
          <ul>
            <li>Cách Tích Điểm</li>
            <li>Thành Viên VIP</li>
          </ul>
        </div>
        <div class="ft-col">
          <h4>CHI NHÁNH 1</h4>
          <p>Liên Hệ: 0903324511</p>
          <p>123 Đường Mới, P.1, Q.1, TP.HCM</p>
        </div>
        <div class="ft-col">
          <h4>CHI NHÁNH 2</h4>
          <p>Liên Hệ: 0901326987</p>
          <p>285/66 Cách Mạng Tháng Tám, P.12, Q.10, TP.HCM</p>
        </div>
        <div class="ft-col">
          <h4>CHÍNH SÁCH MUA HÀNG</h4>
          <ul>
            <li>Chính sách bảo mật</li>
            <li>Chính sách giao hàng</li>
            <li>Chính sách đổi trả</li>
            <li>Phản hồi chất lượng phục vụ</li>
          </ul>
        </div>
      </div>

      <div class="footer-extras">                           
        <div class="social">
          <h5>THEO DÕI SHOP TẠI:</h5>
          <a href="https://www.facebook.com/DNHuyHoang" class="social-fb"><i class="fab fa-facebook-f"></i></a>
          <a href="https://www.instagram.com/youngkh.04/" class="social-instagram"><i class="fab fa-instagram"></i></a>
        </div>
        <div class="tax">
          <h5>MÃ SỐ THUẾ:</h5>
          <div>3903327891</div>
          <div style="margin-top:6px; font-weight:700">CÔNG TY TNHH YOUNGKH WHEY</div>
          <div>321 Đường Phạm Văn Đồng P.Hạnh Thông Q.Gò Vấp TP.Hồ Chí Minh</div>
        </div>
        <div class="bct">
          <h5>ĐÃ THÔNG BÁO</h5>
          <img src="/IMG/bocongthuong.png" alt="Đã thông báo Bộ Công Thương" style="max-width:140px;">
        </div>
      </div>
    </div>
    

    <div class="footer-bottom">
      <div>Bản quyền thuộc về @YOUNGKH WHEY  .</div>
      <div class="payments">
        <div>Những sản phẩm đăng trên website không phải là thuốc, không có tác dụng thay thế thuốc chữa bệnh.</div>
        <div style="margin-left:18px; display:inline-flex; gap:10px; align-items:center">
          <i class="fab fa-cc-visa" title="Visa"></i>
          <i class="fab fa-cc-mastercard" title="Mastercard"></i>
          <i class="fab fa-cc-paypal" title="PayPal"></i>
        </div>
      </div>
    </div>
    <div class="product-grid" id="productGrid">
    </div>
    
  </footer>
    <script src="phonggym.js"></script>
  <script>
  const TARGET_CATEGORY = 'Creatine'; // Tên category cần lọc (dùng chung)

  document.addEventListener("productsLoaded", () => {
    const targetCategory = TARGET_CATEGORY;

        // 1. Xử lý tìm kiếm (nếu có)
        const q = new URLSearchParams(window.location.search).get('q');
        if (q) {
            doSearchQuery(q); 
            return;
        }
        
        // 2. Load sản phẩm Creatine và render (Dùng hàm đã fix lỗi trim/case-insensitive)
        loadProductsByCategory(targetCategory);
        
        // 3. Khởi tạo Sidebar Filters (cần chạy sau khi products đã có)
        // (Giả định hàm này nằm trong phonggym.js hoặc đã được định nghĩa)
        if (typeof initSidebarFilters === 'function') {
            initSidebarFilters();
        }

        // Sửa tiêu đề trang
        document.querySelector('h2').textContent = targetCategory + ' Supplements';
    });
    
    // Sidebar filter wiring - Đảm bảo chỉ áp dụng logic lọc Creatine
    // If products are already available when DOMContentLoaded fires,
    // render the Creatine category immediately so the user doesn't
    // have to click twice.
    document.addEventListener('DOMContentLoaded', () => {
      try {
        if (typeof products !== 'undefined' && Array.isArray(products) && products.length) {
          loadProductsByCategory(TARGET_CATEGORY);
        }
      } catch(e) {}
        
        const CREATINE_CAT = 'Creatine';
        const applyBtn = document.getElementById('applyFilters');
        const clearBtn = document.getElementById('clearFilters');
        const resultLabel = document.getElementById('resultCount');
        
        function getSortValue(){ const s = document.getElementById('sortSelect'); return s ? s.value : 'featured'; }

        function applyFilters() {
            // FIX: Đảm bảo lọc category TRƯỚC VÀ TRÊN TOÀN BỘ sản phẩm
            let arr = (products || []).filter(p => ((p.categoryNormalized || p.category || '')).toLowerCase().trim() === CREATINE_CAT.toLowerCase());

            const instock = document.getElementById('filter-instock').checked;
            const outstock = document.getElementById('filter-outstock').checked;
            if (instock && !outstock) arr = arr.filter(p => p.stock !== false);
            if (!instock && outstock) arr = arr.filter(p => p.stock === false);
            // ... (rest of filtering logic for min/max price, brands) ...
            
            const min = parseInt(document.getElementById('priceMin').value) || null;
            const max = parseInt(document.getElementById('priceMax').value) || null;
            if (min) arr = arr.filter(p => p.price >= min);
            if (max) arr = arr.filter(p => p.price <= max);

            const checkedBrands = Array.from(document.querySelectorAll('.brand-checkbox:checked')).map(b => b.value.toLowerCase());
            if (checkedBrands.length) {
                arr = arr.filter(p => checkedBrands.some(b => (p.title || '').toLowerCase().includes(b)));
            }

            const sort = getSortValue();
            if (sort === 'price-asc') arr.sort((a,b)=>a.price-b.price);
            if (sort === 'price-desc') arr.sort((a,b)=>b.price-a.price);

            renderProducts(arr);
            if (resultLabel) resultLabel.textContent = `${arr.length} Sản Phẩm`;
        }

        function clearFilters() {
            // ... (rest of clearing logic) ...
            document.getElementById('filter-instock').checked = false;
            document.getElementById('filter-outstock').checked = false;
            document.getElementById('priceMin').value = '';
            document.getElementById('priceMax').value = '';
            document.querySelectorAll('.brand-checkbox').forEach(b=>b.checked = false);
            
            // FIX: Chạy lại filter với bộ lọc rỗng để về trạng thái ban đầu
            applyFilters();
            
            const initialCount = (products || []).filter(p => ((p.categoryNormalized || p.category || '')).toLowerCase().trim() === CREATINE_CAT.toLowerCase()).length;
            if (resultLabel) resultLabel.textContent = `${initialCount} Sản Phẩm`;
        }

        applyBtn?.addEventListener('click', applyFilters);
        clearBtn?.addEventListener('click', clearFilters);
        const sortSelect = document.getElementById('sortSelect');
        sortSelect?.addEventListener('change', () => applyFilters());
    });
    </script>
    <script>
      // Ensure wishlist badge is updated on Creatine page (handle timing variations)
      (function(){
        function invokeUpdater(){
          try{
            if (typeof forceUpdateWishlistBadges === 'function') { forceUpdateWishlistBadges(); return true; }
            if (typeof updateWishlistUI === 'function') { updateWishlistUI(); return true; }
          }catch(e){}
          return false;
        }

        if (!invokeUpdater()) setTimeout(() => { invokeUpdater(); }, 80);
        let attempts = 0; const maxAttempts = 12;
        const poll = setInterval(()=>{ attempts++; if (invokeUpdater() || attempts>=maxAttempts) clearInterval(poll); }, 150);

        window.addEventListener('storage', () => { invokeUpdater(); });
        window.addEventListener('wishlistChanged', () => { invokeUpdater(); });
      })();
    </script>
      <script>
        // Backup mạnh: cập nhật mọi badge tim trên header từ localStorage trực tiếp (giống TrangChu)
        (function(){
          function readWishlistCount(){ try { return JSON.parse(localStorage.getItem('wishlist') || '[]').length; } catch(e) { return 0; } }

          function updateHeaderWishlistBadges(){
            try {
              const count = readWishlistCount();
              document.querySelectorAll('#wishlistCount').forEach(el => { el.textContent = count > 0 ? String(count) : '0'; });

              const icons = Array.from(document.querySelectorAll('.header-inner i.fa-heart, .icon-btn i.fa-heart, header i.fa-heart'));
              icons.forEach(icon => {
                const container = icon.closest('a,button,div') || icon.parentElement;
                if (!container) return;
                let badge = container.querySelector('span') || icon.nextElementSibling;
                if (badge && badge.tagName === 'SPAN') {
                  try { badge.textContent = count > 0 ? String(count) : '0'; } catch(e){}
                } else {
                  const s = document.createElement('span');
                  s.id = 'wishlistCount';
                  s.textContent = count > 0 ? String(count) : '0';
                  s.style.cssText = 'position:relative;margin-left:6px;background:#ff3b30;color:#fff;padding:3px 6px;border-radius:50%;font-size:11px';
                  container.appendChild(s);
                }
                try { if (count > 0) container.classList.add('has-wishlist'); else container.classList.remove('has-wishlist'); container.setAttribute('aria-label', `Sản phẩm yêu thích: ${count}`); } catch(e){}
              });
            } catch(e) {}
          }

          try { updateHeaderWishlistBadges(); } catch(e){}
          window.addEventListener('storage', (e)=>{ if (e.key === 'wishlist') try{ updateHeaderWishlistBadges(); }catch(e){} });
          window.addEventListener('wishlistChanged', ()=>{ try{ updateHeaderWishlistBadges(); }catch(e){} });
          setTimeout(updateHeaderWishlistBadges, 200);
          setTimeout(updateHeaderWishlistBadges, 800);
        })();
      </script>
</body>
</html>
